name: Test Desktop Builds

# Manual trigger - can be run from any branch via GitHub Actions UI
on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build'
        type: choice
        options:
          - all
          - windows
          - linux-x64
          - linux-arm64
          - macos-arm64
          - macos-intel
        default: 'all'

jobs:
  build-windows:
    name: Test Build - Windows
    if: ${{ inputs.platforms == 'all' || inputs.platforms == 'windows' }}
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Run Windows build script
        run: ./scripts/build-windows.sh
        shell: bash

      - name: Find Windows Installer
        id: find_exe
        run: |
          $asset = Get-ChildItem -Path frontend/dist-electron -Filter '*.exe' -Recurse -File | Select-Object -First 1
          if ($asset) {
            echo "path=$($asset.FullName)" >> $env:GITHUB_OUTPUT
            echo "Found: $($asset.FullName)"
          } else {
            echo "No .exe found"
            exit 1
          }
        shell: powershell

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: frontend/dist-electron/*.exe
          retention-days: 7

  build-linux-x64:
    name: Test Build - Linux (x64)
    if: ${{ inputs.platforms == 'all' || inputs.platforms == 'linux-x64' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm
          sudo gem install fpm

      - name: Run Linux build script
        run: |
          chmod +x ./scripts/build-linux.sh
          ./scripts/build-linux.sh

      - name: Find Linux Installers
        id: find_linux
        run: |
          APPIMAGE=$(find frontend/dist-electron -name '*.AppImage' -type f | head -n 1)
          DEB=$(find frontend/dist-electron -name '*.deb' -type f | head -n 1)
          if [ -n "$APPIMAGE" ] || [ -n "$DEB" ]; then
            echo "Found: $APPIMAGE $DEB"
          else
            echo "No Linux packages found"
            exit 1
          fi

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-installer
          path: |
            frontend/dist-electron/*.AppImage
            frontend/dist-electron/*.deb
          retention-days: 7

  build-linux-arm64:
    name: Test Build - Linux (ARM64)
    if: ${{ inputs.platforms == 'all' || inputs.platforms == 'linux-arm64' }}
    runs-on: ubuntu-22.04-arm  # Use 22.04 for GLIBC 2.35 compatibility with Raspberry Pi OS
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm
          sudo gem install fpm

      - name: Run Linux ARM64 build script
        run: |
          chmod +x ./scripts/build-linux-arm64.sh
          ./scripts/build-linux-arm64.sh

      - name: Find Linux Installers
        id: find_linux
        run: |
          APPIMAGE=$(find frontend/dist-electron -name '*.AppImage' -type f | head -n 1)
          DEB=$(find frontend/dist-electron -name '*.deb' -type f | head -n 1)
          if [ -n "$APPIMAGE" ] || [ -n "$DEB" ]; then
            echo "Found: $APPIMAGE $DEB"
          else
            echo "No Linux packages found"
            exit 1
          fi

      - name: Upload Linux ARM64 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64-installer
          path: |
            frontend/dist-electron/*.AppImage
            frontend/dist-electron/*.deb
          retention-days: 7

  build-macos-arm64:
    name: Test Build - macOS (Apple Silicon)
    if: ${{ inputs.platforms == 'all' || inputs.platforms == 'macos-arm64' }}
    runs-on: macos-latest  # macos-latest is arm64 (Apple Silicon)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Run macOS build script
        run: |
          chmod +x ./scripts/build-macos.sh
          ./scripts/build-macos.sh

      - name: Find macOS Installer
        id: find_dmg
        run: |
          DMG=$(find frontend/dist-electron -name '*.dmg' -type f | head -n 1)
          if [ -n "$DMG" ]; then
            echo "path=$DMG" >> $GITHUB_OUTPUT
            echo "Found: $DMG"
          else
            echo "No .dmg found"
            exit 1
          fi

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-installer
          path: frontend/dist-electron/*.dmg
          retention-days: 7

  build-macos-intel:
    name: Test Build - macOS (Intel)
    if: ${{ inputs.platforms == 'all' || inputs.platforms == 'macos-intel' }}
    runs-on: macos-15-intel  # Intel Mac runner (macos-13 is deprecated)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Run macOS build script (Intel)
        run: |
          chmod +x ./scripts/build-macos-intel.sh
          ./scripts/build-macos-intel.sh

      - name: Find macOS Installer
        id: find_dmg
        run: |
          DMG=$(find frontend/dist-electron -name '*.dmg' -type f | head -n 1)
          if [ -n "$DMG" ]; then
            echo "path=$DMG" >> $GITHUB_OUTPUT
            echo "Found: $DMG"
          else
            echo "No .dmg found"
            exit 1
          fi

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-installer
          path: frontend/dist-electron/*.dmg
          retention-days: 7

  summary:
    name: Build Summary
    needs: [build-windows, build-linux-x64, build-linux-arm64, build-macos-arm64, build-macos-intel]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check build results
        run: |
          echo "## Test Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux (x64) | ${{ needs.build-linux-x64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux (ARM64) | ${{ needs.build-linux-arm64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS (Apple Silicon) | ${{ needs.build-macos-arm64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS (Intel) | ${{ needs.build-macos-intel.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts are available for download for 7 days." >> $GITHUB_STEP_SUMMARY

# Feature Plan: Corporate Actions & Income Tracking

**Status:  ✅ Done**
**Feature ID:** FR4.5, FR4.6
**Title:** Implement Tracking for Dividends, Stock Splits, and Bonus Issues
**User Story:** As a long-term investor, I want to log all corporate actions and income events related to my holdings, so that my portfolio's quantity, cost basis, and total returns are always accurate.

---

## 1. Objective

This feature introduces the ability for users to manually log three critical events that affect their **stock/equity holdings**: dividend payments, stock splits, and bonus share issues. The initial implementation will focus on manual entry through a unified transaction form, with distinct logic for each action. This is a foundational step for accurate, long-term portfolio performance tracking. **Corporate actions for other asset classes (e.g., Mutual Fund dividends, Bond coupons) are out of scope for this feature.**

---

## 2. High-Level Requirements

A new "Corporate Action" transaction type will be added to the transaction form. Selecting this will reveal a sub-type dropdown for "Dividend", "Stock Split", or "Bonus Issue", each presenting a unique set of fields.

---

## 3. Detailed Feature Breakdown

### 3.1. Dividend Tracking (FR4.5)

*   **User Story:** As a user who receives dividends from my stock holdings, I want to log these dividend payments, so that I can accurately track my total returns and the income generated by my portfolio.

*   **Functional Requirements:**
    *   Users must be able to manually add a "Dividend" corporate action for a specific stock.
    *   The dividend form must capture: asset ticker, total dividend amount, and payment date.
    *   Logged dividends should be reflected in a new "Income" report or dashboard section.

*   **Acceptance Criteria:**
    *   **Scenario 1 (Cash Dividend):** Given I have stock holdings, when I add a cash dividend transaction, then the total dividend amount should be reflected in my income report and should not affect my holdings quantity.

### 3.2. Stock Split Tracking (FR4.6)

*   **User Story:** As a user whose stocks have undergone a split, I want to log this corporate action, so that my share quantity and cost basis are automatically and accurately adjusted.

*   **Functional Requirements:**
    *   Users must be able to manually add a "Stock Split" corporate action for a specific stock.
    *   The split form must capture: asset ticker, split ratio (e.g., 2 for 1), and effective date.
    *   When a split is logged, the system must adjust the quantity of all existing `BUY` and `SELL` transactions for that asset that occurred *before* the split date.
    *   The system must also adjust the purchase price of those same transactions to keep the total invested amount for each transaction constant.

*   **Acceptance Criteria:**
    *   **Scenario 1 (Holdings View):** Given I hold 10 shares of "STOCK_A" bought at $100/share, when I log a 2-for-1 stock split, then my consolidated holdings view should update to show 20 shares and an average cost basis of $50/share.
    *   **Scenario 2 (Transaction View):** Given the split in Scenario 1, when I view the drill-down for "STOCK_A", then the original `BUY` transaction should now show a quantity of 20 and a price of $50, while the total invested amount remains $1000.

### 3.3. Stock Bonus Tracking (FR4.6)

*   **User Story:** As a user whose stocks have issued a bonus, I want to log this corporate action, so that my share quantity is increased and my average cost basis is accurately recalculated.

*   **Functional Requirements:**
    *   Users must be able to manually add a "Bonus Issue" corporate action for a specific stock.
    *   The bonus form must capture: asset ticker, bonus ratio (e.g., 1:1), and effective date.
    *   When a bonus is logged, the system must automatically create a new `BUY` transaction for the bonus shares with a price of zero.
    *   The date of this new zero-cost transaction should be the effective date of the bonus issue.

*   **Acceptance Criteria:**
    *   **Scenario 1 (Holdings View):** Given I hold 10 shares of "STOCK_A" with a total invested amount of $1000, when I log a 1:1 bonus issue, then my holdings should update to 20 shares.
    *   **Scenario 2 (Transaction View):** Given the bonus in Scenario 1, when I view my transactions, then a new `BUY` transaction for 10 shares at a price of $0 should be visible.
    *   **Scenario 3 (Cost Basis):** Given the bonus in Scenario 1, when I view my consolidated holdings, then the average cost basis for "STOCK_A" should be correctly recalculated to $50/share ($1000 / 20 shares).

---

## 4. Backend Requirements

### 4.1. Schema & Model Changes

*   **`TransactionType` Enum:** Add `DIVIDEND`, `SPLIT`, and `BONUS` to the `TransactionType` enum in `schemas/transaction.py`.
*   **`Transaction` Model:** No schema changes are strictly necessary for the `transactions` table itself. The different actions will be handled by business logic based on the `transaction_type`. The `quantity` and `price_per_unit` fields will be repurposed to store the action's parameters.
    *   **For `DIVIDEND`:** `quantity` stores the total cash amount. `price_per_unit` is 1. A new `is_reinvested` boolean field will be added to the `TransactionCreate` schema.
    *   **For `SPLIT`:** `quantity` stores the "new" part of the ratio (e.g., **2** for a 2-for-1 split). `price_per_unit` stores the "old" part (e.g., **1**). 
    *   **For `BONUS`:** `quantity` stores the number of new shares received. `price_per_unit` stores the number of old shares held for that ratio (e.g., for a 1:2 bonus, `quantity`=1, `price_per_unit`=2). 

### 4.2. Business Logic (CRUD Layer)

The core of the backend work will be in a new `crud_corporate_action.py` module.

*   **Stock Split Logic:**
    *   This is the most complex part. When a `SPLIT` transaction is processed, the logic must:
        1.  Fetch all `BUY` and `SELL` transactions for the given asset with a date *before* the split's effective date.
        2.  Iterate through each of these historical transactions.
        3.  Update the `quantity` by multiplying it by the split ratio (new/old).
        4.  Update the `price_per_unit` by dividing it by the split ratio to maintain the original transaction value.
        5.  Commit all these changes in a single database transaction. The `SPLIT` transaction itself is also saved for audit purposes.

*   **Bonus Issue Logic:**
    *   When a `BONUS` transaction is processed, the logic must:
        1.  Calculate the net holdings of the asset on the effective date.
        2.  Calculate the number of bonus shares to be issued based on the ratio and the net holdings.
        3.  Create a new `BUY` transaction for the bonus shares with a `price_per_unit` of `0`.

### 4.3. API Endpoints

*   The existing `POST /api/v1/portfolios/{portfolio_id}/transactions/` endpoint will be enhanced.
*   The endpoint will inspect the `transaction_type`. If it is `DIVIDEND`, `SPLIT`, or `BONUS`, it will delegate to the new corporate action business logic instead of the standard `crud.transaction.create_with_portfolio` path.

---

## 5. Frontend Implementation Plan

### 5.1. UI/UX Flow & Mockups

The core of the user interaction will happen within the existing `TransactionFormModal`. The goal is to seamlessly integrate the new corporate actions into the current transaction flow.

1.  **Entry Point:** The user clicks the "Add Transaction" button on the `PortfolioDetailPage`.
2.  **Asset Selection:** The user selects an existing asset (e.g., "TCS") from the asset search input.
3.  **Transaction Type Selection:** The user selects "Corporate Action" from the **Transaction Type** dropdown. This is the key change from the previous plan.

    ```text
    ┌──────────────────────────────────────────────────────────┐
    │ Add Transaction                                       [X]│
    ├──────────────────────────────────────────────────────────┤
    │  Asset Type:       [ Stock                        ▼ ]       │
    │  Asset:             [ TCS (Tata Consultancy Services)      ▼ ]       │
    │  Transaction Type: [ Corporate Action             ▼ ]       │
    │                    (Options: Buy, Sell, Corporate Action)  │
    └──────────────────────────────────────────────────────────┘
    ```

4.  **Dynamic Form Change:** When "Corporate Action" is selected from the "Transaction Type" dropdown, the form will dynamically change. The standard "Quantity" and "Price" fields will be hidden, and a new "Action Type" dropdown will appear below it.

    ```text
    ┌──────────────────────────────────────────────────────────┐
    │ Add Corporate Action for TCS                          [X]│
    ├──────────────────────────────────────────────────────────┤
    │  Asset: [ TCS (Tata Consultancy Services)      ▼ ]       │
    │  Transaction Type: [ Corporate Action             ▼ ]       │
    │  Action Type:      [ Stock Split                ▼ ]       │
    │                    (Options: Dividend, Stock Split, Bonus) │
    └──────────────────────────────────────────────────────────┘
    ```

5.  **Action-Specific Fields:** Based on the "Action Type" selected, a specific set of input fields will be rendered.

    *   **If "Stock Split" is selected:**
        ```text
        │  Action Type: [ Stock Split ▼ ]                         │
        │                                                          │
        │  Effective Date:   [ 2024-10-28   ]                       │
        │  Split Ratio:      New [ 2 ] for every Old [ 1 ] shares  │
        │                                                          │
        │                                     [ Cancel ] [ Save ]  │
        ```

    *   **If "Bonus Issue" is selected:**
        ```text
        │  Action Type: [ Bonus Issue ▼ ]                        │
        │                                                          │
        │  Effective Date:   [ 2024-11-15   ]                       │
        │  Bonus Ratio:      New [ 1 ] for every Old [ 1 ] shares  │
        │                                                          │
        │                                     [ Cancel ] [ Save ]  │
        ```

    *   **If "Dividend" is selected:**
        ```text
        │  Action Type: [ Dividend ▼ ]                           │
        │                                                          │
        │  Payment Date:     [ 2024-12-01   ]                       │
        │  Total Amount:     [ 1500.00      ]                       │
        │                                     [ Cancel ] [ Save ]  │
        ```

### 5.2. Data Layer & State Management

*   The existing `useCreateTransaction` hook will be used. The frontend will construct the correct payload based on the selected corporate action.
*   The `onSuccess` callback will need to invalidate all relevant queries (`['portfolioHoldings', portfolioId]`, `['portfolioSummary', portfolioId]`, `['assetTransactions', assetId]`, `['assetAnalytics', assetId]`) to ensure the UI reflects the changes to quantity, cost basis, and transaction history.

---

## 6. Testing Plan

*   **Backend Unit Tests:**
    *   Write specific tests for the stock split logic, ensuring it correctly modifies historical transactions.
    *   Test the bonus issue logic, ensuring a zero-cost `BUY` transaction is created.
*   **Frontend Component Tests:**
    *   Write tests for `TransactionFormModal` to verify that the correct form fields are rendered for each corporate action type.
*   **E2E Tests:**
    *   Create a new E2E test suite (`corporate-actions.spec.ts`).
    *   **Test Case 1 (Split):** Create a holding, log a 2-for-1 split, and verify that the consolidated holdings view and the transaction drill-down view both show the correct, updated quantity and price.
    *   **Test Case 2 (Bonus):** Create a holding, log a 1:1 bonus, and verify that a new zero-cost transaction appears and the average cost basis is correctly halved.
    *   **Test Case 3 (Dividend):** Log a cash dividend and verify it appears correctly in the (future) income report.

---

## 6. Step-by-Step Implementation Plan for Jules

This plan breaks the feature into smaller, manageable, and testable phases.

### Phase 1: Backend Foundation
1.  **Update Enums:** Add `DIVIDEND`, `SPLIT`, `BONUS` to the `TransactionType` enum in `backend/app/schemas/enums.py`.
2.  **Update Schemas:** Add an optional `is_reinvested: bool = False` field to the `TransactionCreate` schema in `backend/app/schemas/transaction.py`.
4.  **Update API Endpoint:** Modify the `create_transaction` endpoint in `backend/app/api/v1/endpoints/transactions.py`. Add a conditional check: if the `transaction_type` is one of the new corporate actions, call a placeholder function in the new CRUD module. Otherwise, use the existing logic. The `TransactionCreateIn` schema will also need to be updated to accept the new corporate action fields.

### Phase 2: Implement Bonus Issue Logic
1.  **Implement `handle_bonus_issue`:** In `crud_corporate_action.py`, create a function `handle_bonus_issue(db: Session, *, portfolio_id: UUID, asset_id: UUID, transaction_in: schemas.TransactionCreate)`.
2.  **Logic:**
    *   Use `crud.holding.get_holdings_on_date()` to calculate the net quantity of the asset held on the `transaction_date`.
    *   Calculate the number of bonus shares to issue based on the ratio provided in `transaction_in` and the net holdings.
    *   Create a new `schemas.TransactionCreate` object for a `BUY` transaction with the calculated bonus quantity and a `price_per_unit` of 0.
    *   Use `crud.transaction.create_with_portfolio()` to save this new `BUY` transaction.
    *   Save the original `BONUS` transaction itself for auditing.
3.  **Testing:** Create a new test file `backend/app/tests/crud/test_corporate_actions.py` and add a unit test specifically for the bonus issue logic.

### Phase 3: Implement Dividend Logic
### Phase 4: Implement Stock Split Logic (Most Complex)
1.  **Implement `handle_stock_split`:** In `crud_corporate_action.py`, create a function `handle_stock_split(...)`.
2.  **Logic:**
    *   Fetch all `BUY` and `SELL` transactions for the given `asset_id` and `portfolio_id` with a `transaction_date` *before* the effective date from `transaction_in`.
    *   Loop through each of these historical transactions.
    *   For each one, update its `quantity` and `price_per_unit` based on the split ratio. Use `db.add()` to stage the changes.
    *   Save the `SPLIT` transaction itself for auditing.
    *   Use a single `db.commit()` at the end to save all changes atomically.
3.  **Testing:** Add a unit test for the stock split logic. Ensure it correctly modifies historical transactions and maintains the total value of each.

### Phase 5: Frontend Implementation
1.  **Update `TransactionFormModal.tsx`:** Implement the dynamic UI changes as described in the UI/UX Flow section.
2.  **Update `useCreateTransaction`:** Ensure the hook in `usePortfolios.ts` sends the correct payload for each corporate action type.
3.  **Testing:** Update the unit tests for `TransactionFormModal.test.tsx` to verify the new UI states.

### Phase 6: E2E Testing
1.  Create the `corporate-actions.spec.ts` E2E test file and implement the three test cases outlined in section 6.
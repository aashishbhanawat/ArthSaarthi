# FR8.4: Advanced Analytics for ESPP & RSU Holdings

**Status: ✅ Done**

## 1. Introduction

This document outlines the plan to enhance the backend analytics engine to correctly calculate valuation and performance metrics (Unrealized P&L, XIRR) for holdings acquired via ESPP and RSU plans. This builds upon the data captured in **FR8.1.1** and **FR8.2**.

**User Story:** "As an investor with ESPP and RSU holdings, I want the application to accurately calculate my investment performance, so I can understand the true return on these assets beyond just the income I received."

## 2. Problem Description

Standard analytics calculations are insufficient for ESPP/RSU assets:

1.  **RSU Cost Basis:** The user's cash cost for RSUs is $0, but for performance tracking, the "investment" should be considered the Fair Market Value (FMV) on the vest date. Calculating XIRR from a $0 cost basis would result in an infinite return, which is not a useful metric for tracking the stock's performance *after* vesting.
2.  **ESPP Bargain Element:** The discount received on an ESPP purchase (the "bargain element") is a key part of the benefit. While the user's cost basis is the discounted price, analytics should be able to represent the total benefit.

## 3. Proposed Solution

The backend analytics engine (`crud_holding.py` and `crud_analytics.py`) will be refactored to handle these special transaction types.

### 3.1. RSU Analytics Logic

When calculating performance metrics for an `RSU_VEST` transaction, the system will use the **Fair Market Value (FMV) at Vest** as the effective cost basis.

*   **Source of Data:** The `fmv_at_vest` will be read from the transaction's `metadata` field.
*   **Source of Data:** The `fmv` will be read from the transaction's `details` field.
*   **Unrealized P&L Calculation:**
    *   `Unrealized P&L = (Current Price - FMV at Vest) * Quantity`
*   **XIRR Cash Flow:**
    *   For the purpose of XIRR calculation, an `RSU_VEST` transaction will be treated as a cash outflow equal to `(FMV at Vest * Quantity)` on the vest date.

*   **Foreign Currency Handling:** For foreign stocks (e.g., in USD), the `fmv` is in the foreign currency. For all INR-based calculations (like P&L shown on the dashboard), this value must be multiplied by the `fx_rate` also stored in the transaction's `details`.
    *   `Unrealized P&L (INR) = (Current Price * Current FX Rate - FMV at Vest * Vest FX Rate) * Quantity`

**Rationale:** This approach correctly measures the performance of the stock from the moment the user takes ownership. It answers the question, "How has my stock performed since it was granted to me?"

### 3.2. ESPP Analytics Logic

For ESPP, the user's actual cash cost is the correct cost basis for most investment tracking.

*   **Source of Data:** The `price_per_unit` of the `ESPP_PURCHASE` transaction (which is the discounted price) will be used.
*   **Unrealized P&L Calculation (Cost Basis):**
    *   `Unrealized P&L = (Current Price - Purchase Price) * Quantity`
*   **XIRR Cash Flow:**
    *   The cash flow for an `ESPP_PURCHASE` is a standard outflow equal to `(Purchase Price * Quantity)` on the purchase date.

**Displaying the Benefit:** While the core calculation uses the purchase price, the UI (e.g., the holding drill-down modal) will be enhanced to display the "bargain element" benefit derived from the metadata.

*   **Benefit Display:**
    *   `Total Discount Received = (FMV - Purchase Price) * Quantity`
    *   This will be read from the transaction's `details` and displayed separately from the Unrealized P&L.

### 3.3. Handling "Sell to Cover"

The `SELL` transaction generated by a "Sell to Cover" event is a standard sale. The analytics engine will treat it like any other `SELL` transaction, using its proceeds as a positive cash inflow for realized P&L and XIRR calculations. This requires no special changes.

## 4. Backend Implementation

*   **File to Modify:** `backend/app/crud/crud_holding.py` and `backend/app/crud/crud_analytics.py`.
*   **Logic:** The functions responsible for calculating holdings and analytics will be updated. They will need to inspect the `transaction_type` and, if it is `RSU_VEST`, use the `metadata.fmv_at_vest` as the price instead of the transaction's `price_per_unit`. For all other types, the existing logic will apply.
*   **Logic:** The `_process_market_traded_assets` function in `crud_holding.py` was updated. It now inspects the `transaction_type`. If it is `RSU_VEST`, it uses the `fmv` from the `details` field as the cost basis. For `BUY` and `ESPP_PURCHASE`, it uses the transaction's `price_per_unit`. It correctly applies the `fx_rate` in all cases to calculate the `total_invested` amount in INR.

## 5. Testing Plan (Backend)

*   **Backend Unit Tests:**
    *   **File:** `backend/app/tests/crud/test_holdings.py`
    *   **Test RSU Unrealized P&L (INR Stock):** `✅ Done`
        1.  Create a holding with an `RSU_VEST` transaction for an INR stock.
        2.  Mock the current price of the asset.
        3.  Call the holdings endpoint and assert that the `total_invested_amount` is calculated using the `fmv` from the transaction's details.
    *   **Test RSU Unrealized P&L (Foreign Stock):** `✅ Done`
        1.  Create a holding with an `RSU_VEST` for a USD stock, including `fmv` and `fx_rate` in details.
        2.  Mock the current price (in USD) and a different current FX rate.
        3.  Call the holdings endpoint and assert that the `total_invested_amount` is correctly calculated in INR using the `fmv` and `fx_rate`.
    *   **File:** `backend/app/tests/crud/test_analytics.py`
    *   **Test RSU XIRR:**
        1.  Create a holding with an `RSU_VEST` transaction.
        2.  Call the asset analytics endpoint.
        3.  Assert that the XIRR calculation uses a cash outflow based on the `fmv_at_vest`, not zero.
    *   **Test ESPP Analytics:**
        1.  Create a holding with an `ESPP_PURCHASE` transaction.
        2.  Assert that the `unrealized_pnl` is correctly calculated based on the discounted purchase price.

*   **E2E Tests:**
    *   No new E2E tests are strictly required for this FR, as the validation is primarily at the backend calculation level. Existing E2E tests that check P&L values on the dashboard and portfolio pages will serve as regression tests.